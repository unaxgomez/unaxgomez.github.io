<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <title>Sticky Notes con Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/paper@0.12.6/dist/paper-full.js"></script>
    <style>
      * {
        font-family: "Inter", serif;
        font-optical-sizing: auto;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        box-sizing: border-box;
      }

      html {
        height: 100%;
      }

      body {
        background-color: #d8d8d8;
        overflow: hidden;
        margin: 0;
      }

      .background {
        height: 100%;
        width: 100%;
        background-color: #2e5936; /* Color verde típico de las bases de corte */
        /* border: 2px solid rgb(70, 146, 83); */
        position: relative;
        overflow: hidden;
      }

      /* Patrón de líneas */
      .background::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: repeating-linear-gradient(
            0deg,
            rgba(80, 166, 94, 0.2) 0px,
            rgba(80, 166, 94, 0.2) 1px,
            transparent 1px,
            transparent 20px
          ),
          repeating-linear-gradient(
            90deg,
            rgba(80, 166, 94, 0.2) 0px,
            rgba(80, 166, 94, 0.2) 1px,
            transparent 1px,
            transparent 20px
          ),
          repeating-linear-gradient(
            0deg,
            rgba(80, 166, 94, 0.3) 0px,
            rgba(80, 166, 94, 0.3) 1px,
            transparent 1px,
            transparent 100px
          ),
          repeating-linear-gradient(
            90deg,
            rgba(80, 166, 94, 0.3) 0px,
            rgba(80, 166, 94, 0.3) 1px,
            transparent 1px,
            transparent 100px
          ),
          repeating-linear-gradient(
            45deg,
            rgba(80, 166, 94, 0.2) 0px,
            rgba(80, 166, 94, 0.2) 1px,
            transparent 1px,
            transparent 100px
          ),
          repeating-linear-gradient(
            -45deg,
            rgba(80, 166, 94, 0.2) 0px,
            rgba(80, 166, 94, 0.2) 1px,
            transparent 1px,
            transparent 100px
          );
        pointer-events: none;
      }

      .shadow {
        mix-blend-mode: multiply;
        z-index: 100;
        position: absolute;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
      }

      .create-container {
        display: flex;
        flex-direction: column;
        align-items: left;
      }

      .deployer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 8px;
        cursor: pointer;
      }

      .title {
        margin: 0;
        padding: 8px 0 8px 0;
        font-size: 18px;
        color: white;
        line-height: 1;
      }

      .image {
        border: 1px solid #e2e2e2;
        border-radius: 4px;
        height: 150px;
        pointer-events: none;
      }

      .name {
        font-weight: 500;
        font-size: 10px;
        margin: 0;
        padding-top: 4px;
        color: #7c7c7c;
      }

      .message {
        font-weight: 500;
        font-size: 12px;
        margin: 0;
        padding-top: 4px;
        line-height: 140%;
      }

      .button {
        float: right;
        background-color: #e75448;
        padding: 10px 15px;
        color: white;
        border-radius: 4px;
        cursor: pointer;
      }

      #board {
        display: flex;
        position: relative;
        height: 100vh;
        width: 100vw;
      }

      .note {
        position: absolute;
        width: 200px;
        background: white;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #e2e2e2;
        box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.2);
      }

      #note-creator {
        bottom: -385px;
      }

      textarea,
      input {
        width: 100%;
        border: 1px solid #9e270c;
        border-radius: 4px;
        max-height: 100px;
        max-width: 100%;
        margin-bottom: 4px;
        background: #e3350e;
      }

      textarea {
        min-height: 50px;
      }

      input,
      select,
      textarea {
        color: #551b0e;
        font-weight: 500;
      }

      input,
      .input,
      textarea,
      select {
        -webkit-appearance: none;
        outline: none;
        resize: none;
        border-radius: 0.2em;
        border: 1px solid #9e270c;
        box-shadow: none;
        font-size: 16px;
        font-weight: 500;
        padding: 0.6em;
        margin-right: 0.6em;
        margin-bottom: 8px;
      }
      input::placeholder,
      textarea::placeholder {
        color: #9e270c;
      }
      input:hover:not(:disabled):not(:focus),
      .input:hover:not(:disabled):not(:focus),
      textarea:hover:not(:disabled):not(:focus),
      select:hover:not(:disabled):not(:focus) {
        border-color: #9e270c;
      }
      input:focus,
      .input:focus,
      textarea:focus,
      select:focus {
        border-color: #9e270c;
      }

      textarea:focus,
      input:focus {
        outline: none;
      }

      canvas {
        width: 100%;
        height: 200px;
        background: white;
        border: 1px solid #e2e2e2;
        border-radius: 4px;
        padding: 8px 0;
      }

      button {
        border: none;
        padding: 12px 16px;
        margin-top: 8px;
        font-weight: 500;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        background-color: #006af6;
        color: white;
        width: 100%;
      }

      button:hover {
        transition: all 0.2s ease-in-out;
        background-color: rgb(0, 91, 210);
      }

      button:not(:hover) {
        transition: all 0.2s ease-in-out;
      }

      #note-creator {
        z-index: 99;
        position: fixed;
        bottom: 0;
        border-radius: 8px 8px 0 0;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        background: #ff3c10;
        padding: 10px;
        box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="board">
      <div class="background">
        <div id="note-creator">
          <div class="create-container">
            <div class="deployer">
              <h2 class="title">Escríbeme una nota</h2>
              <img src="chevron.svg" />
            </div>
            <div>
              <input id="name-input" placeholder="Tu Nombre" />
              <textarea
                id="message-input"
                placeholder="Escribe tu mensaje"
              ></textarea>
              <canvas id="drawing-canvas" resize></canvas>
              <button id="save-note-btn">Guardar</button>
            </div>
          </div>
        </div>
      </div>
      <img src="shadow.jpg" class="shadow" />
    </div>

    <script type="module">
      import { supabase } from "./supabaseClient.js";
      console.log("Supabase conectado", supabase);

      document.addEventListener("DOMContentLoaded", function () {
        const noteCreator = document.getElementById("note-creator");
const deployer = document.querySelector(".deployer");
const chevron = deployer.querySelector("img"); // Seleccionamos el chevron (la imagen)

if (noteCreator && deployer && chevron) {
  // Inicialmente plegado
  noteCreator.style.bottom = "-385px"; // Oculta la card fuera de la pantalla
  noteCreator.style.transition = "bottom 0.3s ease-in-out";
  chevron.style.transition = "transform 0.3s ease-in-out"; // Añadimos una transición para la rotación

  deployer.addEventListener("click", function () {
    if (noteCreator.style.bottom === "0px") {
      noteCreator.style.bottom = "-385px"; // Baja la card
      chevron.style.transform = "rotate(0deg)"; // Rota el chevron a su posición original
    } else {
      noteCreator.style.bottom = "0px"; // Sube la card
      chevron.style.transform = "rotate(180deg)"; // Rota el chevron 180 grados
    }
  });
}


      });

      function makeDraggable(note) {
        let isDragging = false;
        let offsetX, offsetY;
        let lastX, lastY;
        let velocityX = 0,
          velocityY = 0; // Velocidades de inercia
        let finalRotation = null; // Variable para almacenar la rotación final

        note.style.transform = `rotate(${(Math.random() * 20 - 10).toFixed(
          2
        )}deg)`; // Rotar una vez al inicio

        note.addEventListener("mousedown", (e) => {
          isDragging = true;
          offsetX = e.clientX - note.getBoundingClientRect().left;
          offsetY = e.clientY - note.getBoundingClientRect().top;
          lastX = e.clientX;
          lastY = e.clientY;
          velocityX = 0;
          velocityY = 0;
          note.style.transition = "none"; // Desactiva la transición mientras se arrastra
          note.style.userSelect = "none"; // Desactiva la selección de texto

          // Resetear la rotación aleatoria cuando se empieza a mover
          finalRotation = (Math.random() * 20 - 10).toFixed(2); // Generar nueva rotación aleatoria
        });

        document.addEventListener("mousemove", (e) => {
          if (!isDragging) return;

          // Calculamos el movimiento
          let newX = e.clientX - offsetX;
          let newY = e.clientY - offsetY;

          // Limitar el movimiento dentro de los límites permitidos (50px fuera del viewport)
          const maxX = window.innerWidth - note.offsetWidth - 50;
          const maxY = window.innerHeight - note.offsetHeight - 50;

          // Evitar que se mueva fuera del área permitida
          newX = Math.min(Math.max(newX, -50), maxX);
          newY = Math.min(Math.max(newY, -50), maxY);

          note.style.left = `${newX}px`;
          note.style.top = `${newY}px`;

          // Calcular la velocidad en base al desplazamiento
          velocityX = (e.clientX - lastX) * 0.1; // Factor de suavizado
          velocityY = (e.clientY - lastY) * 0.1;
          lastX = e.clientX;
          lastY = e.clientY;
        });

        document.addEventListener("mouseup", () => {
          if (isDragging) {
            isDragging = false;
            note.style.transition =
              "transform 0.3s ease-out, left 0.3s ease-out, top 0.3s ease-out"; // Transición suave

            // Deslizarse con inercia
            const inertia = setInterval(() => {
              if (Math.abs(velocityX) < 1 && Math.abs(velocityY) < 1) {
                clearInterval(inertia); // Detener el movimiento cuando la velocidad sea baja
              }

              // Aplicar la inercia
              let newX = parseFloat(note.style.left || 0) + velocityX;
              let newY = parseFloat(note.style.top || 0) + velocityY;

              // Limitar el movimiento dentro de los límites permitidos
              const maxX = window.innerWidth - note.offsetWidth - 50;
              const maxY = window.innerHeight - note.offsetHeight - 50;

              newX = Math.min(Math.max(newX, -50), maxX);
              newY = Math.min(Math.max(newY, -50), maxY);

              note.style.left = `${newX}px`;
              note.style.top = `${newY}px`;

              // Reducir la velocidad para simular la inercia
              velocityX *= 0.95; // Desaceleración
              velocityY *= 0.95;
            }, 16); // Intervalo para actualizar el movimiento (aproximadamente 60fps)

            // Aplicar la rotación final de manera suave
            note.style.transform = `rotate(${finalRotation}deg)`; // Rotar al soltar
            note.style.userSelect = "auto"; // Restaurar la selección de texto al soltar el clic
          }
        });
      }

      document
        .getElementById("save-note-btn")
        .addEventListener("click", saveNote);

      // Configura Paper.js en el canvas
      paper.setup("drawing-canvas");

      // Crea un trazo vacío y lo hace editable
      let path;

      // Configura el pincel
      let tool = new paper.Tool();
      tool.minDistance = 10; // Distancia mínima para empezar a dibujar

      tool.onMouseDown = function (event) {
        // Inicia el trazo
        path = new paper.Path();
        path.strokeColor = "#1A1A1A"; // Color del trazo
        path.strokeWidth = 3; // Grosor del trazo
        path.lineJoin = "round"; // Conexión redondeada entre las líneas
        path.lineCap = "round"; // Puntas redondeadas al final de las líneas
        path.add(event.point);
      };

      tool.onMouseDrag = function (event) {
        // Continúa el trazo mientras el mouse se mueve
        path.add(event.point);
        path.smooth(); // Suaviza las líneas a medida que se dibujan
      };

      tool.onMouseUp = function (event) {
        // Finaliza el trazo
        path.smooth(); // Suaviza al final del trazo
      };

      async function saveNote() {
        const name = document.getElementById("name-input").value;
        const message = document.getElementById("message-input").value;

        // Convierte el dibujo a imagen
        const dataUrl = paper.view.element.toDataURL(); // Obtener la imagen del lienzo

        if (!name || !message) {
          alert("Por favor, completa todos los campos");
          return;
        }

        const { data, error } = await supabase
          .from("notes")
          .insert([{ name, message, image: dataUrl }]);

        if (error) {
          console.error("Error al guardar la nota:", error);
        } else {
          console.log("Nota guardada correctamente:", data);
          document.getElementById("name-input").value = "";
          document.getElementById("message-input").value = "";
          paper.project.clear(); // Limpia el canvas
        }
      }

      function addStickyNote() {
        if (document.getElementById("note-creator")) return; // Evita duplicar la card
        console.log("Mostrando el formulario para agregar una nueva nota.");
      }

      async function loadNotes() {
        const { data, error } = await supabase
          .from("notes")
          .select("*")
          .order("created_at", { ascending: false })
          .limit(20);

        if (error) {
          console.error(error);
          return;
        }

        // Borra solo las notas, pero NO el formulario de creación
        const notes = document.querySelectorAll(".note");
        notes.forEach((note) => note.remove());

        data.forEach(addNoteToBoard);
      }

      loadNotes();

      supabase
        .channel("notes")
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "notes" },
          (payload) => {
            console.log("Nueva nota recibida:", payload.new);
            addNoteToBoard(payload.new);
          }
        )
        .subscribe();

      function addNoteToBoard(note) {
        const div = document.createElement("div");
        div.classList.add("note");
        const noteWidth = div.offsetWidth; // Obtener el ancho de la nota
        const noteHeight = div.offsetHeight; // Obtener la altura de la nota

        // Asegúrate de que las notas no se salgan del contenedor
        const maxX = window.innerWidth - noteWidth - 50; // Restamos 50px como margen
        const maxY = window.innerHeight - noteHeight - 50; // Restamos 50px como margen

        // Generar las posiciones aleatorias, respetando el tamaño de las notas y el contenedor
        const randomX = Math.random() * maxX;
        const randomY = Math.random() * maxY;
        const randomRotation = (Math.random() * 20 - 10).toFixed(2); // -10 a 10 grados

        div.style.transform = `rotate(${randomRotation}deg)`;

        div.style.left = `${randomX}px`;
        div.style.top = `${randomY}px`;

        div.innerHTML = `
        <img class="image" src="${note.image}" width="100%">
        <p class="name">${note.name}</p>
        <p class="message">${note.message}</p>
  `;

        makeDraggable(div);

        document.getElementById("board").appendChild(div);
      }
    </script>
  </body>
</html>
